{% extends "base.html" %}

{% block title %}Dashboard - Employee Attendance System{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header Section -->
    <div class="dashboard-header">
        <div class="header-content">
            <h1 class="text-gradient">Attendance Dashboard</h1>
            <p class="subtitle">Monitor and manage employee attendance records</p>
        </div>
        <div class="header-actions">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search employees...">
            </div>
            <a href="{{ url_for('logout') }}" class="btn-logout">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <div class="filter-group">
            <label>Date Range:</label>
            <input type="date" id="startDate" class="filter-input">
            <input type="date" id="endDate" class="filter-input">
        </div>
        <div class="filter-group">
            <label>Department:</label>
            <select id="departmentFilter" class="filter-input">
                <option value="">All Departments</option>
                {% for dept in departments %}
                <option value="{{ dept }}">{{ dept }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label>Status:</label>
            <select id="statusFilter" class="filter-input">
                <option value="">All Status</option>
                <option value="Complete">Complete</option>
                <option value="Checked In">Checked In</option>
                <option value="Absent">Absent</option>
            </select>
        </div>
    </div>

    <!-- Attendance Table -->
    <div class="table-container">
        <div class="table-header">
            <h2>Attendance Records</h2>
            <div class="table-actions">
                <button class="btn-action" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i>
                    Export
                </button>
                <button class="btn-action" onclick="printTable()">
                    <i class="fas fa-print"></i>
                    Print
                </button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="attendance-table" id="attendanceTable">
                <thead>
                    <tr>
                        <th>Employee ID</th>
                        <th>Name</th>
                        <th>Department</th>
                        <th>Date</th>
                        <th>Check In</th>
                        <th>Check Out</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in metrics %}
                    <tr>
                        <td>{{ record.ID }}</td>
                        <td>{{ record.Name }}</td>
                        <td>{{ record.Department }}</td>
                        <td>{{ record.Date }}</td>
                        <td>{{ record['Attendance Time'] }}</td>
                        <td>{{ record['Leave Time'] }}</td>
                        <td>
                            {% if record['Leave Time'] %}
                                <span class="status-badge complete">Complete</span>
                            {% elif record['Attendance Time'] %}
                                <span class="status-badge checked-in">Checked In</span>
                            {% else %}
                                <span class="status-badge absent">Absent</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-danger btn-sm" 
                                    onclick="confirmDelete('{{ record.ID }}', '{{ record.Name }}')"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#deleteModal">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add this modal for delete confirmation -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this employee? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('delete_employee') }}" method="POST" id="deleteForm">
                    <input type="hidden" name="emp_id" id="deleteEmpId">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
:root {
    --primary: #4a90e2;
    --secondary: #2c3e50;
    --accent: #e74c3c;
    --success: #2ecc71;
    --warning: #f1c40f;
    --danger: #e74c3c;
    --light: #f8f9fa;
    --dark: #343a40;
    --white: #ffffff;
    --gray: #6c757d;
    --border: #dee2e6;
}

.dashboard-container {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--border);
}

.header-content h1 {
    font-size: 2.5rem;
    margin: 0;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.subtitle {
    color: var(--gray);
    margin: 0.5rem 0 0;
    font-size: 1.1rem;
}

.header-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.search-box {
    position: relative;
    width: 300px;
}

.search-box i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray);
}

.search-box input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
}

.search-box input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
}

.btn-logout {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: var(--danger);
    color: var(--white);
    border: none;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-logout:hover {
    background: #c0392b;
    transform: translateY(-1px);
}

.filters-section {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 2rem;
    padding: 1rem;
    background: var(--light);
    border-radius: 10px;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.filter-group label {
    font-weight: 500;
    color: var(--dark);
}

.filter-input {
    padding: 0.5rem;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.9rem;
}

.table-container {
    background: var(--white);
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    overflow: hidden;
}

.table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
}

.table-header h2 {
    margin: 0;
    font-size: 1.5rem;
    color: var(--dark);
}

.table-actions {
    display: flex;
    gap: 1rem;
}

.btn-action {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--light);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--dark);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-action:hover {
    background: var(--primary);
    color: var(--white);
    border-color: var(--primary);
}

.attendance-table {
    width: 100%;
    border-collapse: collapse;
}

.attendance-table th {
    background: var(--light);
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--dark);
    border-bottom: 2px solid var(--border);
}

.attendance-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--border);
    color: var(--dark);
}

.attendance-table tbody tr:hover {
    background: rgba(74, 144, 226, 0.05);
}

.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
    text-align: center;
    display: inline-block;
}

.status-badge.complete {
    background: rgba(46, 204, 113, 0.1);
    color: var(--success);
}

.status-badge.checked-in {
    background: rgba(241, 196, 15, 0.1);
    color: var(--warning);
}

.status-badge.absent {
    background: rgba(231, 76, 60, 0.1);
    color: var(--danger);
}

@media (max-width: 1200px) {
    .dashboard-header {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
    }
    
    .header-actions {
        width: 100%;
        flex-direction: column;
    }
    
    .search-box {
        width: 100%;
    }
    
    .filters-section {
        flex-direction: column;
    }
    
    .filter-group {
        width: 100%;
    }
    
    .filter-input {
        flex: 1;
    }
}

@media (max-width: 768px) {
    .dashboard-container {
        padding: 1rem;
    }
    
    .table-header {
        flex-direction: column;
        gap: 1rem;
    }
    
    .table-actions {
        width: 100%;
        justify-content: space-between;
    }
    
    .btn-action {
        flex: 1;
        justify-content: center;
    }
}

.btn-danger {
    background-color: var(--danger);
    border-color: var(--danger);
    color: white;
    transition: all 0.3s ease;
}

.btn-danger:hover {
    background-color: #dc3545;
    border-color: #dc3545;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-danger:active {
    transform: translateY(0);
}

.modal-content {
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.modal-header {
    background-color: var(--light);
    border-bottom: 1px solid var(--border-color);
    border-radius: 8px 8px 0 0;
}

.modal-footer {
    background-color: var(--light);
    border-top: 1px solid var(--border-color);
    border-radius: 0 0 8px 8px;
}
</style>

<script>
// Search functionality
document.getElementById('searchInput').addEventListener('input', function(e) {
    const searchText = e.target.value.toLowerCase();
    const table = document.getElementById('attendanceTable');
    const rows = table.getElementsByTagName('tr');

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        let found = false;

        for (let j = 0; j < cells.length; j++) {
            const cell = cells[j];
            if (cell.textContent.toLowerCase().indexOf(searchText) > -1) {
                found = true;
                break;
            }
        }

        row.style.display = found ? '' : 'none';
    }
});

// Filter functionality
function applyFilters() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const department = document.getElementById('departmentFilter').value;
    const status = document.getElementById('statusFilter').value;
    
    const table = document.getElementById('attendanceTable');
    const rows = table.getElementsByTagName('tr');

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        let show = true;

        // Date filter
        if (startDate && endDate) {
            const date = cells[3].textContent;
            if (date < startDate || date > endDate) {
                show = false;
            }
        }

        // Department filter
        if (department && cells[2].textContent !== department) {
            show = false;
        }

        // Status filter
        if (status) {
            const statusCell = cells[6].textContent.trim();
            if (statusCell !== status) {
                show = false;
            }
        }

        row.style.display = show ? '' : 'none';
    }
}

// Add event listeners to filters
document.getElementById('startDate').addEventListener('change', applyFilters);
document.getElementById('endDate').addEventListener('change', applyFilters);
document.getElementById('departmentFilter').addEventListener('change', applyFilters);
document.getElementById('statusFilter').addEventListener('change', applyFilters);

// Export to Excel
function exportToExcel() {
    const table = document.getElementById('attendanceTable');
    const html = table.outerHTML;
    const url = 'data:application/vnd.ms-excel;charset=utf-8,' + encodeURIComponent(html);
    const downloadLink = document.createElement('a');
    document.body.appendChild(downloadLink);
    downloadLink.href = url;
    downloadLink.download = 'attendance_report.xls';
    downloadLink.click();
    document.body.removeChild(downloadLink);
}

// Print table
function printTable() {
    const printContents = document.getElementById('attendanceTable').outerHTML;
    const originalContents = document.body.innerHTML;
    document.body.innerHTML = printContents;
    window.print();
    document.body.innerHTML = originalContents;
}

function confirmDelete(empId, empName) {
    document.getElementById('deleteEmpId').value = empId;
    document.querySelector('#deleteModal .modal-body').innerHTML = 
        `Are you sure you want to delete employee ${empName} (ID: ${empId})? This action cannot be undone.`;
}

// Add this to your existing JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // ... existing code ...

    // Add delete form submission handler
    document.getElementById('deleteForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const form = this;
        fetch(form.action, {
            method: 'POST',
            body: new FormData(form)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                // Show success message
                showAlert('success', data.message);
                // Reload page after short delay
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showAlert('error', data.message);
            }
        })
        .catch(error => {
            showAlert('error', 'An error occurred while deleting the employee.');
        });
    });
});
</script>
{% endblock %} 